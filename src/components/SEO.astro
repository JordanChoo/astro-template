---
/**
 * SEO Component
 *
 * Comprehensive SEO meta tags including Open Graph and Twitter cards.
 * Uses site config for defaults and templates.
 *
 * @example
 * ```astro
 * <SEO
 *   title="About Us"
 *   description="Learn about our company"
 *   type="website"
 * />
 * ```
 */

import siteConfig from '@/config/site';

export interface Props {
  /** Page title (inserted into titleTemplate) */
  title: string;
  /** Meta description (warns if > 160 chars) */
  description?: string;
  /** Canonical URL (defaults to current page URL) */
  canonicalUrl?: string;
  /** Open Graph image URL (absolute or relative) */
  image?: string;
  /** OG image width in pixels */
  imageWidth?: number;
  /** OG image height in pixels */
  imageHeight?: number;
  /** Whether to add noindex meta tag */
  noindex?: boolean;
  /** Open Graph type (default: "website", use "article" for blog posts) */
  type?: 'website' | 'article';
  /** Twitter handle for article author (without @) */
  twitterCreator?: string;
}

const {
  title,
  description = siteConfig.seo.defaultDescription,
  canonicalUrl,
  image,
  imageWidth,
  imageHeight,
  noindex = false,
  type = 'website',
  twitterCreator,
} = Astro.props;

// Build the full title using the template
const fullTitle = siteConfig.seo.titleTemplate.replace('%s', title);

// Warn if description is too long (SEO best practice)
if (description && description.length > 160) {
  console.warn(
    `[SEO] Meta description for "${title}" is ${description.length} characters. ` +
      `Consider keeping it under 160 characters for optimal SEO.`
  );
}

// Determine canonical URL
// Handles pagination by using the provided URL or defaulting to current page
const currentUrl = new URL(Astro.url.pathname, siteConfig.seo.siteUrl).href;
const canonical = canonicalUrl ?? currentUrl;

// Resolve image URL (convert relative to absolute)
function resolveImageUrl(img: string | undefined): string | undefined {
  if (!img) return undefined;
  if (img.startsWith('http://') || img.startsWith('https://')) {
    return img;
  }
  // Handle relative URLs
  const path = img.startsWith('/') ? img : `/${img}`;
  return new URL(path, siteConfig.seo.siteUrl).href;
}

// Determine OG image with fallback chain: page prop -> config default -> undefined
const ogImage = resolveImageUrl(image) ?? resolveImageUrl(siteConfig.seo.ogImage);

// Determine OG image dimensions
const ogImageWidth = imageWidth ?? (image ? undefined : siteConfig.seo.ogImageWidth);
const ogImageHeight = imageHeight ?? (image ? undefined : siteConfig.seo.ogImageHeight);

// Format Twitter handle (add @ if needed)
function formatTwitterHandle(handle: string | undefined): string | undefined {
  if (!handle) return undefined;
  return handle.startsWith('@') ? handle : `@${handle}`;
}

const twitterSite = formatTwitterHandle(siteConfig.twitterHandle);
const twitterCreatorHandle = formatTwitterHandle(twitterCreator);
---

{/* Essential meta tags */}
<title>{fullTitle}</title>
<meta name="description" content={description} />
<link rel="canonical" href={canonical} />
<meta name="viewport" content="width=device-width, initial-scale=1" />

{/* Robots directive */}
{noindex && <meta name="robots" content="noindex" />}

{/* Open Graph tags */}
<meta property="og:title" content={fullTitle} />
<meta property="og:description" content={description} />
<meta property="og:url" content={canonical} />
<meta property="og:type" content={type} />
<meta property="og:site_name" content={siteConfig.name} />

{/* OG Image (only if available) */}
{ogImage && <meta property="og:image" content={ogImage} />}
{ogImage && ogImageWidth && <meta property="og:image:width" content={String(ogImageWidth)} />}
{ogImage && ogImageHeight && <meta property="og:image:height" content={String(ogImageHeight)} />}

{/* Twitter Card tags */}
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={fullTitle} />
<meta name="twitter:description" content={description} />
{ogImage && <meta name="twitter:image" content={ogImage} />}
{twitterSite && <meta name="twitter:site" content={twitterSite} />}
{twitterCreatorHandle && <meta name="twitter:creator" content={twitterCreatorHandle} />}
