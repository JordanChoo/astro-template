---
/**
 * Individual Blog Post Page
 *
 * Renders a single blog post with PostLayout.
 * Includes BlogPostingLD and BreadcrumbLD for structured data.
 * Uses SEO component with post-specific metadata.
 */

import { getCollection, getEntry, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

import PostLayout from '@/layouts/PostLayout.astro';
import SEO from '@/components/SEO.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import BlogPostingLD from '@/components/seo/BlogPostingLD.astro';
import BreadcrumbLD from '@/components/seo/BreadcrumbLD.astro';
import { calculateReadingTime } from '@/utils/reading-time';
import { getRelatedPosts } from '@/utils/related-posts';
import PostCard from '@/components/PostCard.astro';
import siteConfig from '@/config/site';

type BlogPost = CollectionEntry<'blog'>;

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');

  // In production, only generate pages for non-draft posts
  const isProduction = import.meta.env.PROD;
  const filteredPosts = isProduction ? allPosts.filter((post) => !post.data.draft) : allPosts;

  return filteredPosts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

interface Props {
  post: BlogPost;
}

const { post } = Astro.props;

// Render the post content
const { Content } = await render(post);

// Get the raw body content for reading time calculation
// Note: In Astro 5.x, we need to use the body property
const bodyContent = post.body ?? '';

// Calculate reading time
const readingTimeMinutes = calculateReadingTime(bodyContent);
const readingTime = `${readingTimeMinutes} min read`;

// Get author data
const author = await getEntry(post.data.author);
const authorData = author
  ? { name: author.data.name, slug: author.data.slug }
  : { name: 'Unknown Author', slug: '' };

// Get related posts
const allPosts = await getCollection('blog');
const isProduction = import.meta.env.PROD;
const visiblePosts = isProduction ? allPosts.filter((p) => !p.data.draft) : allPosts;
const relatedPosts = getRelatedPosts(post, visiblePosts, 3);

// Fetch author data for related posts
const relatedPostsWithAuthors = await Promise.all(
  relatedPosts.map(async (relatedPost) => {
    const relatedAuthor = await getEntry(relatedPost.data.author);
    return {
      post: relatedPost,
      author: relatedAuthor
        ? { name: relatedAuthor.data.name, slug: relatedAuthor.data.slug }
        : { name: 'Unknown Author', slug: '' },
    };
  })
);

// Prepare breadcrumb data
const breadcrumbItems = [
  { name: 'Home', url: '/' },
  { name: 'Blog', url: '/blog/' },
  { name: post.data.title, url: `/blog/${post.id}/` },
];

// Normalize tags to lowercase with hyphens
const normalizedTags = post.data.tags.map((tag) => tag.toLowerCase().replace(/\s+/g, '-'));
---

<PostLayout
  title={post.data.title}
  description={post.data.description}
  pubDate={post.data.pubDate}
  author={authorData}
  image={post.data.image}
  readingTime={readingTime}
  tags={normalizedTags}
>
  <Fragment slot="head">
    <SEO
      title={post.data.title}
      description={post.data.description}
      image={post.data.image}
      type="article"
    />
    <BlogPostingLD
      headline={post.data.title}
      description={post.data.description}
      datePublished={post.data.pubDate.toISOString()}
      author={{
        name: authorData.name,
        url: authorData.slug ? `${siteConfig.seo.siteUrl}/team/${authorData.slug}/` : undefined,
      }}
      image={post.data.image}
    />
    <BreadcrumbLD items={breadcrumbItems} />
  </Fragment>

  <Breadcrumbs currentPath={Astro.url.pathname} />

  <Content />

  {/* Related Posts Section */}
  {
    relatedPostsWithAuthors.length > 0 && (
      <section class="mt-16 pt-12 border-t border-neutral-200">
        <h2 class="text-2xl font-bold text-neutral-900 mb-8">Related Posts</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedPostsWithAuthors.map(({ post: relatedPost, author: relatedAuthor }) => (
            <PostCard
              slug={relatedPost.id}
              title={relatedPost.data.title}
              description={relatedPost.data.description}
              pubDate={relatedPost.data.pubDate}
              author={relatedAuthor}
              tags={relatedPost.data.tags}
              image={relatedPost.data.image}
              isDraft={!isProduction && relatedPost.data.draft}
            />
          ))}
        </div>
      </section>
    )
  }
</PostLayout>
