---
/**
 * Location Detail Page
 *
 * Dynamic page for individual location details.
 * Includes address, phone, operating hours, coordinates, service area,
 * and links to all services.
 */

import PageLayout from '../../layouts/PageLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import SEO from '../../components/SEO.astro';
import LocalBusinessLD from '../../components/seo/LocalBusinessLD.astro';
import BreadcrumbLD from '../../components/seo/BreadcrumbLD.astro';
import siteConfig from '../../config/site';
import {
  getAllLocationSlugs,
  getLocationBySlug,
  formatSchemaOrgHours,
  formatDisplayHours,
} from '../../content/locations/locations.schema';
import { getSortedServices } from '../../content/services/services.schema';

export function getStaticPaths() {
  const slugs = getAllLocationSlugs();
  return slugs.map((slug) => ({
    params: { slug },
  }));
}

interface Props {
  params: { slug: string };
}

const { slug } = Astro.params;
const currentPath = Astro.url.pathname;

// Get the location data
const location = getLocationBySlug(slug);

// Handle case where location is not found (should not happen with getStaticPaths)
if (!location) {
  return Astro.redirect('/404');
}

// Get phone number (fallback to site config if not specified)
const phoneNumber = location.phone ?? siteConfig.phone;

// Get all services for cross-reference links
const services = getSortedServices();

// Format operating hours for display and Schema.org
const displayHours = location.operatingHours ? formatDisplayHours(location.operatingHours) : null;
const schemaOrgHours = location.operatingHours
  ? formatSchemaOrgHours(location.operatingHours)
  : undefined;

// Parse address for LocalBusinessLD
// Format: "123 Main Street, Suite 500, Austin, TX 78701"
function parseAddress(
  fullAddress: string,
  city: string,
  state: string
): {
  street: string;
  city: string;
  state: string;
  zip: string;
} {
  // Extract zip code (last word that looks like a zip)
  const zipMatch = fullAddress.match(/\b(\d{5}(?:-\d{4})?)\b/);
  const zip = zipMatch ? zipMatch[1] : '';

  // Extract street (everything before city)
  const cityStateZipPattern = new RegExp(`\\s*,?\\s*${city}\\s*,?\\s*${state}\\s*${zip}\\s*$`, 'i');
  const street = fullAddress.replace(cityStateZipPattern, '').replace(/,\s*$/, '').trim();

  return { street, city, state, zip };
}

const parsedAddress = parseAddress(location.address, location.city, location.state);

// SEO title and description
const seoTitle = `${location.city}, ${location.state} Office`;
const seoDescription = location.description;

// Breadcrumb items for structured data
const breadcrumbItems = [
  { name: 'Home', url: '/' },
  { name: 'Locations', url: '/locations' },
  { name: `${location.city}, ${location.state}`, url: `/locations/${location.slug}` },
];
---

<PageLayout title={seoTitle}>
  <Fragment slot="head">
    <SEO title={seoTitle} description={seoDescription} />
    <LocalBusinessLD
      name={`${siteConfig.name} - ${location.city} Office`}
      address={parsedAddress}
      phone={phoneNumber}
      geo={location.coordinates}
      openingHours={schemaOrgHours}
    />
    <BreadcrumbLD items={breadcrumbItems} />
  </Fragment>

  <Breadcrumbs currentPath={currentPath} />

  <article class="max-w-4xl mx-auto px-4 py-12 sm:px-6 lg:px-8">
    <!-- Location Header -->
    <header class="mb-12">
      <!-- Location Icon -->
      <div
        class="w-16 h-16 bg-primary-100 rounded-xl flex items-center justify-center mb-6 text-primary-600"
      >
        <svg
          class="w-8 h-8"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"></path>
        </svg>
      </div>

      <!-- City and State -->
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-neutral-900 mb-4">
        {location.city}, {location.state}
      </h1>

      <!-- Short Description -->
      <p class="text-lg sm:text-xl text-neutral-600">
        {location.description}
      </p>
    </header>

    <!-- Contact Information -->
    <section class="mb-12 bg-neutral-50 rounded-xl p-6 sm:p-8 border border-neutral-200">
      <h2 class="text-xl font-bold text-neutral-900 mb-6">Contact Information</h2>

      <div class="space-y-4">
        <!-- Address -->
        <div class="flex items-start gap-4">
          <div
            class="flex-shrink-0 w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z"
              ></path>
            </svg>
          </div>
          <div>
            <p class="text-sm font-medium text-neutral-500 mb-1">Address</p>
            <p class="text-neutral-900">{location.address}</p>
          </div>
        </div>

        <!-- Phone -->
        {
          phoneNumber && (
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0 w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"
                  />
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-neutral-500 mb-1">Phone</p>
                <a
                  href={`tel:${phoneNumber.replace(/[^\d+]/g, '')}`}
                  class="text-primary-600 hover:text-primary-700 font-medium"
                >
                  {phoneNumber}
                </a>
              </div>
            </div>
          )
        }

        <!-- Coordinates (if available) -->
        {
          location.coordinates && (
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0 w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 6.75V15m6-6v8.25m.503 3.498l4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 00-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0z"
                  />
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-neutral-500 mb-1">Coordinates</p>
                <p class="text-neutral-900 font-mono text-sm">
                  {location.coordinates.lat.toFixed(4)}, {location.coordinates.lng.toFixed(4)}
                </p>
              </div>
            </div>
          )
        }
      </div>
    </section>

    <!-- Long Description -->
    <section class="mb-12">
      <h2 class="text-xl font-bold text-neutral-900 mb-4">About This Location</h2>
      <div class="prose prose-neutral prose-lg max-w-none">
        <p class="text-neutral-700 leading-relaxed">
          {location.longDescription}
        </p>
      </div>
    </section>

    <!-- Operating Hours (only if configured) -->
    {
      displayHours && (
        <section class="mb-12">
          <h2 class="text-xl font-bold text-neutral-900 mb-6">Operating Hours</h2>
          <div class="bg-neutral-50 rounded-xl border border-neutral-200 overflow-hidden">
            <ul class="divide-y divide-neutral-200">
              {displayHours.map((hours) => {
                const [day, times] = hours.split(': ');
                return (
                  <li class="flex justify-between items-center px-6 py-3">
                    <span class="font-medium text-neutral-900">{day}</span>
                    <span class="text-neutral-600">{times}</span>
                  </li>
                );
              })}
            </ul>
          </div>
        </section>
      )
    }

    <!-- Service Area Keywords -->
    <section class="mb-12">
      <h2 class="text-xl font-bold text-neutral-900 mb-4">Service Area</h2>
      <p class="text-neutral-600 mb-4">We proudly serve clients throughout the following areas:</p>
      <div class="flex flex-wrap gap-2">
        {
          location.serviceAreaKeywords.map((keyword) => (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-800">
              {keyword}
            </span>
          ))
        }
      </div>
    </section>

    <!-- Services Section (Cross-reference to all services) -->
    {
      services.length > 0 && (
        <section class="mb-12">
          <h2 class="text-xl font-bold text-neutral-900 mb-4">
            Services Available at This Location
          </h2>
          <p class="text-neutral-600 mb-6">
            Our {location.city} office provides the full range of our professional services:
          </p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {services.map((service) => (
              <a
                href={`/services/${service.slug}`}
                class="flex items-center gap-3 p-4 bg-white rounded-lg border border-neutral-200 hover:border-primary-300 hover:shadow-sm transition-all group"
              >
                <div class="flex-shrink-0 w-8 h-8 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600 group-hover:bg-primary-600 group-hover:text-white transition-colors">
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    aria-hidden="true"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M4.5 12.75l6 6 9-13.5"
                    />
                  </svg>
                </div>
                <span class="font-medium text-neutral-900 group-hover:text-primary-600 transition-colors">
                  {service.title}
                </span>
              </a>
            ))}
          </div>
        </section>
      )
    }

    <!-- CTA Section -->
    <section class="bg-primary-50 rounded-2xl p-8 sm:p-12 text-center border border-primary-100">
      <h2 class="text-2xl sm:text-3xl font-bold text-neutral-900 mb-4">Get in Touch</h2>
      <p class="text-lg text-neutral-600 mb-8 max-w-2xl mx-auto">
        Ready to work with our {location.city} team? Contact us today to discuss how we can help your
        business.
      </p>
      <a
        href="/contact"
        class="inline-flex items-center justify-center px-8 py-4 text-lg font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
      >
        Contact Us
        <svg
          class="ml-2 w-5 h-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
        </svg>
      </a>
    </section>

    <!-- Back to Locations Link -->
    <div class="mt-12 pt-8 border-t border-neutral-200">
      <a
        href="/locations"
        class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium"
      >
        <svg
          class="mr-2 w-5 h-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
        </svg>
        Back to all locations
      </a>
    </div>
  </article>
</PageLayout>
